

<h2>Vendedores</h2>

<div class="input-append">
    <input class="input-xxlarge " id="filtrar" type="text" placeholder="Nome do vendedor">
    <button id="btnBuscar" class="btn" type="button">Filtrar</button>
    <button id="btnNovo" class="btn btn-primary" type="button">Novo</button>
</div>

<div>
    <table id="tableVendedores" class="table table-bordered table-hover table-striped">
        <thead>
            <tr>
                <th width="10%">Matricula</th>
                <th>Nome</th>
                <th>Login</th>
                <th width="10%">Data Cont.</th>
                <th width="10"></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><a href="">Mark</a></td>
                <td>Otto</td>
                <td><a href="#"><i class="icon-trash"></i></a></td>
            </tr>
        </tbody>
    </table>


    <div class="modal fade" id="novoModal" style="display: none;">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>Vendedor</h3>
        </div>
        <div class="modal-body">

            <div id="saveMessage" class="alert alert-success" style="display:none">
                <img src="img/ajax-loader.gif"> Salvando dados...
            </div>

            <form id="form" class="form-horizontal">
                <input type="hidden" id="inputId">
                <input type="hidden" id="inputIdUsuario">

                <div id="errorEmpty" class="alert alert-error" style="display:none">
                    Campos requeridos
                </div>

                <div id="errorServer" class="alert alert-error" style="display:none"></div>

                <div class="control-group">
                    <label class="control-label" for="inputContratacao">Data Contratação</label>
                    <div class="controls">
                        <input type="text" id="inputContratacao">
                    </div>
                </div>


                <div class="control-group">
                    <label class="control-label" for="inputNome">Nome</label>
                    <div class="controls">
                        <input type="text" id="inputNome" placeholder="Nome" class="input-block-level">
                    </div>
                </div>



                <div class="control-group">
                    <label class="control-label" for="inputEmail">Email</label>
                    <div class="controls">
                        <input type="text" id="inputEmail" placeholder="Email" class="input-block-level">
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="inputLogin">Login</label>
                    <div class="controls">
                        <input type="text" id="inputLogin" placeholder="Login">
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="inputPassword">Senha</label>
                    <div class="controls">
                        <input type="password" id="inputSenha" placeholder="Senha">
                    </div>
                </div>



                <div class="control-group">
                    <label class="control-label" for="inputCpf">Cpf</label>
                    <div class="controls">
                        <input type="text" id="inputCpf" placeholder="Cpf">
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="inputMatricula">Matricula</label>
                    <div class="controls">
                        <input type="text" id="inputMatricula" placeholder="Matricula">
                    </div>
                </div>



            </form>
        </div>
        <div class="modal-footer">
            <a id="salvar" href="#" class="btn btn-primary">Salvar</a>
        </div>
    </div>


    <script>


        $(document).ready(function() {
            verifyLogin();
            atualizaGrid();
            preparaData($("#inputContratacao"));
        });
        $('#btnNovo').click(function() {

            if ($("#inputId").val() != "") {
                $("form")[0].reset();
                $("#inputId").val("");
                $("#inputIdUsuario").val("");
                $("#errorServer").hide();
            }
            $('#novoModal').modal('show');
        });

        $('#btnBuscar').click(function() {
            atualizaGrid();
        });

        $('#salvar').click(function() {

            var valido = true;
            //remove o erro destacado em todos os inputs
            $("#form input").map(function() {
                $(this).parents("div").removeClass("error");
            });
            if ($('#inputNome').val().length == 0)
            {
                valido = false;
                $('#inputNome').parents("div").addClass("error");
            }

            if ($('#inputLogin').val().length == 0)
            {
                valido = false;
                $('#inputLogin').parents("div").addClass("error");
            }

            if ($('#inputSenha').val().length == 0)
            {
                valido = false;
                $('#inputSenha').parents("div").addClass("error");
            }

            if (valido)
            {
                travarFormulario();
                vendedor = JSON.stringify({
                    idVendedor: $("#inputId").val(),
                    idUsuario: $("#inputIdUsuario").val(),
                    nome: $("#inputNome").val(),
                    email: $("#inputEmail").val(),
                    login: $("#inputLogin").val(),
                    senha: $("#inputSenha").val(),
                    cpf: $("#inputCpf").val(),
                    matricula: $("#inputMatricula").val(),
                    dataContratacao: $("#inputContratacao").val(),
                });
                //todo: ajax
                $.ajax({
                    type: "post",
                    url: rootUrl + "vendedor/save",
                    dataType: "json",
                    data: vendedor,
                    success: function(result) {
                        destravarFormulario();
                        $('#novoModal').modal('hide');
                        $("form")[0].reset();
                        atualizaGrid();
                    },
                    error: function(result) {
                        destravarFormulario();
                        console.log(result);
                        $("#errorServer").html(getErrorMessage(result.responseText));
                        $("#errorServer").show();
                    }

                });
            }
            else
            {
                $("#errorEmpty").show("slide");
                $("#erroServer").hide();
            }

        });
        function travarFormulario()
        {
            $("#errorEmpty").hide("slide");
            $("form").hide("slide");
            $("#saveMessage").show("slide");
            $("#salvar").addClass("disabled");
            $("#clearForm").addClass("disabled");
        }

        function destravarFormulario()
        {
            $("#errorEmpty").hide("slide");
            $("form").show("slide");
            $("#saveMessage").hide("slide");
            $("#salvar").removeClass("disabled");
            $("#clearForm").removeClass("disabled");
        }

        function atualizaGrid()
        {
            $("#tableVendedores").find("tbody tr").remove();
            $("#tableVendedores").find("tbody").append('<tr><td colspan=10><div class="alert alert-success"><img src="img/ajax-loader.gif">Carregando...</div></td></tr>')

            filtro = "";
            if ($("#filtrar").val())
                filtro = "/" + $("#filtrar").val();

            $.ajax({
                type: "get",
                url: rootUrl + "vendedor/listAll" + filtro,
                dataType: "json",
                success: function(data) {
                    console.log("success");
                    console.log(data);
                    $("#tableVendedores").find("tbody tr").remove();
                    data.result.forEach(function(vendedor) {

                        $row = "<tr><td>" + vendedor.matricula
                                + "</td><td><a id='edit' href='#' data-id='" + vendedor.id + "'>" + vendedor.nome + "</a>"
                                + "</td><td>" + vendedor.login
                                + "</td><td>" + vendedor.dataContratacao
                                + "</td><td> <a href='#'><i class='icon-remove' data-idUsuario='" + vendedor.idUsuario + "' data-id='" + vendedor.id + "' data-nome='" + vendedor.nome + "'/></i></a>"
                                + "</td></tr>";
                        $("#tableVendedores > tbody:last").append($row);
                    });
                }
            });
        }


        $(".icon-remove").live("click", function() {
            id = $(this).attr("data-id");
            idUsuario = $(this).attr("data-idUsuario");
            nome = $(this).attr("data-nome");
            $row = $(this);
            if (confirm("Excluir " + nome + "?"))
            {

                $.ajax({
                    type: "post",
                    url: rootUrl + "vendedor/delete",
                    dataType: "json",
                    data: JSON.stringify({id: id, idUsuario: idUsuario}),
                    success: function() {
                        $row.parent().parent().parent().fadeTo(400, 0, function() {
                            $row.parent().parent().parent().remove();
                        });
                    },
                    error: function() {
                        
                    }
                });
            }

        });

        $("#edit").live("click", function() {
            id = $(this).attr("data-id");
            $("#errorServer").hide("slide");
            

            $.ajax({
                type: "get",
                url: rootUrl + "vendedor/list/" + id,
                dataType: "json",
                success: function(data) {

                    vendedor = data.result;
                    $("#inputId").val(vendedor.id);
                    $("#inputIdUsuario").val(vendedor.idUsuario);
                    $("#inputNome").val(vendedor.nome);
                    $("#inputEmail").val(vendedor.email);
                    $("#inputLogin").val(vendedor.login);
                    $("#inputSenha").val(vendedor.senha);
                    $("#inputCpf").val(vendedor.cpf);
                    $("#inputMatricula").val(vendedor.matricula);
                    $("#inputContratacao").val(vendedor.dataContratacao);
                    $("#novoModal").modal("show");
                }
            });


        });


    </script>

